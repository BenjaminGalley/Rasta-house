<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fruit Bounce | Rasta House</title>
<style>
body {
    margin: 0;
    background: #0a0a0a;
    font-family: 'Segoe UI', Roboto, sans-serif;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    overflow-x: hidden;
}
h1 {
    margin-top: 20px;
    color: #FFD100;
    font-size: 1.6rem;
    text-align: center;
}
.slot-container {
    position: relative;
    margin-top: 20px;
    width: 320px;
    height: 320px;
    background: #111;
    border-radius: 20px;
    overflow: hidden;
}
.reel-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}
.reel-frame {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('asset/reel.frame.png') no-repeat center;
    background-size: contain;
    pointer-events: none;
    z-index: 3;
}
.reel-mask {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('asset/reel.mask.png') no-repeat center;
    background-size: contain;
    pointer-events: none;
    z-index: 2;
    overflow: hidden;
}
.reel {
    width: 90px;
    height: 270px;
    margin: 0 5px;
    overflow: hidden;
    border-radius: 10px;
    border: 2px solid #FFD100;
    background: #222;
    position: relative;
    z-index: 1;
}
.reel img {
    width: 100%;
    display: block;
}
.reel-glass {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('asset/reel.glass.png') no-repeat center;
    background-size: contain;
    pointer-events: none;
    z-index: 4;
}
.controls {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}
.controls button {
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    background: #FFD100;
    color: black;
    box-shadow: 0 5px 0 #aa8800;
    transition: 0.1s;
}
.controls button:active {
    transform: translateY(4px);
    box-shadow: none;
}
.bet-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
}
.bet-container span {
    font-size: 1.2rem;
    font-weight: bold;
}
.win-message {
    position: absolute;
    top: 10%;
    width: 100%;
    text-align: center;
    font-size: 1.2rem;
    font-weight: bold;
    color: #00ff00;
    text-shadow: 0 0 10px #00ff00;
    z-index: 6;
    display: none;
}
.line-highlight {
    position: absolute;
    width: 100%;
    height: 100%;
    z-index: 5;
    pointer-events: none;
}
.confetti-piece {
    position: absolute;
    width: 6px;
    height: 6px;
    opacity: 0.8;
    z-index: 10;
    pointer-events: none;
    border-radius: 2px;
}
</style>
</head>
<body>

<h1>Fruit Bounce</h1>

<div class="slot-container">
    <div class="reel-wrapper">
        <div class="reel-mask"></div>
        <div class="reel" id="reel1"></div>
        <div class="reel" id="reel2"></div>
        <div class="reel" id="reel3"></div>
        <div class="reel-frame"></div>
        <div class="reel-glass"></div>
        <div class="win-message" id="winMsg"></div>
        <canvas class="line-highlight" id="lineCanvas"></canvas>
    </div>
</div>

<div class="controls">
    <div class="bet-container">
        <button id="bet-decrease">-</button>
        <span id="bet-amount">2</span> ETB
        <button id="bet-increase">+</button>
    </div>
    <button id="spin-btn">SPIN</button>
</div>

<script>
const fruits = [
    {name:"orange", img:"orange.png"},
    {name:"lemon", img:"lemon.png"},
    {name:"cherry", img:"cherry.png"},
    {name:"watermelon", img:"watermelon.png"},
    {name:"grape", img:"grape.png"},
    {name:"banana", img:"banana.png"},
    {name:"scatter", img:"wild.png"}
];

const reels = [
    document.getElementById("reel1"),
    document.getElementById("reel2"),
    document.getElementById("reel3")
];
const lineCanvas = document.getElementById("lineCanvas");
const ctx = lineCanvas.getContext("2d");
lineCanvas.width = 320;
lineCanvas.height = 320;

let betAmount = 2;
const minBet = 2;
const maxBet = 1000;
let freeSpins = 0;

// Initialize reels
reels.forEach(reel => {
    for(let i=0;i<fruits.length;i++){
        const img = document.createElement("img");
        img.src="asset/"+fruits[i].img;
        reel.appendChild(img.cloneNode());
    }
    for(let i=0;i<fruits.length;i++){
        const img = document.createElement("img");
        img.src="asset/"+fruits[i].img;
        reel.appendChild(img.cloneNode());
    }
});

// Random integer helper
function randInt(max){return Math.floor(Math.random()*max);}

// Spin a single reel
function spinReel(reel){
    return new Promise(resolve=>{
        const totalImages = reel.children.length;
        let position = 0;
        const spins = randInt(20)+30;
        let currentSpin = 0;
        const speed = randInt(15)+10;
        const interval = setInterval(()=>{
            position+=speed;
            if(position>=reel.scrollHeight/2) position=0;
            reel.scrollTop = position;
            currentSpin++;
            if(currentSpin>=spins){
                clearInterval(interval);
                const fruitHeight = reel.scrollHeight / totalImages;
                const finalIndex = randInt(fruits.length);
                reel.scrollTop = finalIndex * fruitHeight;
                resolve(finalIndex);
            }
        },30);
    });
}

// Winning lines and payout
function calculatePayout(results){
    const paylines = [
        [0,0,0],[1,1,1],[2,2,2],
        [0,1,2],[2,1,0]
    ];
    let total = 0;
    let winLines = [];
    paylines.forEach((line,index)=>{
        const vals = line.map((i,j)=>results[j][i]);
        const scatterCount = vals.filter(v=>fruits[v].name==="scatter").length;
        if(scatterCount>=5){
            total += betAmount*15;
            freeSpins += 5;
            winLines.push({line:line, payout:betAmount*15, type:"FREE"});
        } else if(vals.every(v=>v===vals[0])){
            total += betAmount*10;
            winLines.push({line:line, payout:betAmount*10, type:"WIN"});
        } else if(vals[0]===vals[1] || vals[1]===vals[2] || vals[0]===vals[2]){
            total += betAmount*2;
            winLines.push({line:line, payout:betAmount*2, type:"WIN"});
        }
    });
    return {total, winLines};
}

// Highlight lines
function drawLines(winLines){
    ctx.clearRect(0,0,lineCanvas.width,lineCanvas.height);
    winLines.forEach(w=>{
        ctx.strokeStyle = w.type==="FREE"? "#00ff00" : "#FFD100";
        ctx.lineWidth = 4;
        ctx.beginPath();
        const yPositions = [45, 135, 225];
        w.line.forEach((v,i)=>{
            const x = 45 + i*100;
            const y = yPositions[v];
            if(i===0) ctx.moveTo(x,y);
            else ctx.lineTo(x,y);
        });
        ctx.stroke();
    });
}

// Display win message
function displayWin(winLines,total){
    drawLines(winLines);
    const msg = document.getElementById("winMsg");
    if(winLines.length>0){
        let text="";
        winLines.forEach(l=>{
            if(l.type==="FREE") text+="FREE SPINS! ";
            else text+=`Line win: ${l.payout} ETB `;
        });
        msg.innerText=text + (total>0? `Total: ${total} ETB`:"");
        msg.style.display="block";
        createConfetti();
        setTimeout(()=>{msg.style.display="none"; ctx.clearRect(0,0,lineCanvas.width,lineCanvas.height);},2500);
    }
}

// Confetti
function createConfetti(){
    for(let i=0;i<60;i++){
        const div = document.createElement("div");
        div.classList.add("confetti-piece");
        div.style.left = Math.random()*320+"px";
        div.style.top = "-10px";
        div.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
        document.body.appendChild(div);
        let speed = Math.random()*3 +2;
        const interval = setInterval(()=>{
            div.style.top = parseFloat(div.style.top)+speed+"px";
            div.style.transform = `rotate(${Math.random()*360}deg)`;
            if(parseFloat(div.style.top)>window.innerHeight){
                clearInterval(interval);
                div.remove();
            }
        },20);
    }
}

// Spin button
document.getElementById("spin-btn").addEventListener("click", async()=>{
    document.getElementById("spin-btn").disabled=true;
    let results = [[],[],[]];
    for(let i=0;i<reels.length;i++){
        results[i] = [];
        for(let r=0;r<3;r++){
            const idx = await spinReel(reels[i]);
            results[i].push(idx);
        }
    }
    const payout = calculatePayout(results);
    displayWin(payout.winLines,payout.total);

    if(freeSpins>0){
        alert(`You earned ${freeSpins} FREE spins!`);
        while(freeSpins>0){
            freeSpins--;
            await new Promise(res=>setTimeout(res,500));
            document.getElementById("spin-btn").click();
        }
    }
    document.getElementById("spin-btn").disabled=false;
});

// Bet controls
document.getElementById("bet-increase").addEventListener("click",()=>{
    if(betAmount<maxBet) betAmount++;
    document.getElementById("bet-amount").innerText=betAmount;
});
document.getElementById("bet-decrease").addEventListener("click",()=>{
    if(betAmount>minBet) betAmount--;
    document.getElementById("bet-amount").innerText=betAmount;
});
</script>
</body>
</html>
