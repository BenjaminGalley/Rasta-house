<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruit Bounce | Rasta House</title>
    <link href="https://fonts.googleapis.com/css2?family=Goldman&display=swap" rel="stylesheet">
    <style>
        :root {
            --rasta-gold: #FFD100;
            --rasta-green: #008542;
            --rasta-red: #E71D36;
        }
        body {
            margin: 0;
            background: #0a0a0a;
            font-family: 'Goldman', sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header & Balance */
        .game-header {
            width: 100%;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.8);
            border-bottom: 2px solid var(--rasta-gold);
            box-sizing: border-box;
        }
        .back-btn {
            background: #333;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.8rem;
        }
        .balance-box {
            background: var(--rasta-green);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid var(--rasta-gold);
            font-weight: bold;
        }

        h1 {
            margin: 20px 0 10px;
            color: var(--rasta-gold);
            font-size: 2.2rem;
            text-shadow: 0 0 15px rgba(255, 209, 0, 0.5);
            font-style: italic;
        }

        /* Slot Machine Area */
        .slot-container {
            position: relative;
            width: 340px;
            height: 380px;
            background: #111;
            border: 4px solid #333;
            border-radius: 25px;
            padding: 10px;
            box-shadow: 0 0 50px rgba(0,0,0,1), inset 0 0 20px rgba(255,255,255,0.05);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .reel-wrapper {
            position: relative;
            display: flex;
            gap: 10px;
            height: 300px; /* Viewport for 3 symbols */
            overflow: hidden;
            background: #000;
            border-radius: 10px;
            padding: 10px;
        }
        .reel {
            width: 90px;
            height: 100%;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .reel-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: transform 0.1s linear;
        }
        .symbol {
            width: 90px;
            height: 90px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            padding: 10px;
        }
        .symbol img {
            max-width: 100%;
            max-height: 100%;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
        }

        /* Controls */
        .controls {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
        }
        .bet-container {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255,255,255,0.05);
            padding: 10px 25px;
            border-radius: 50px;
            border: 1px solid #444;
        }
        .bet-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--rasta-gold);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        .bet-display {
            font-size: 1.5rem;
            color: var(--rasta-gold);
            min-width: 80px;
            text-align: center;
        }
        #spin-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: radial-gradient(circle, var(--rasta-red), #900);
            color: white;
            font-size: 1.4rem;
            font-weight: bold;
            font-family: 'Goldman';
            cursor: pointer;
            box-shadow: 0 8px 0 #600, 0 10px 20px rgba(0,0,0,0.5);
            transition: 0.1s;
        }
        #spin-btn:active:not(:disabled) {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #600;
        }
        #spin-btn:disabled {
            filter: grayscale(1);
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Win Overlay */
        .win-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: var(--rasta-gold);
            text-shadow: 0 0 20px black, 0 0 10px gold;
            z-index: 10;
            pointer-events: none;
            display: none;
            background: rgba(0,0,0,0.7);
            padding: 20px 0;
        }

        .line-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .confetti-piece {
            position: absolute;
            width: 8px;
            height: 8px;
            z-index: 100;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div class="game-header">
    <a href="index.html" class="back-btn">â¬… LOBBY</a>
    <div class="balance-box"><span id="userBal">0.00</span> ETB</div>
</div>

<h1>Fruit Bounce</h1>

<div class="slot-container">
    <div class="win-message" id="winMsg">BIG WIN!</div>
    <canvas id="lineCanvas" class="line-canvas"></canvas>
    
    <div class="reel-wrapper">
        <div class="reel"><div class="reel-container" id="reel0"></div></div>
        <div class="reel"><div class="reel-container" id="reel1"></div></div>
        <div class="reel"><div class="reel-container" id="reel2"></div></div>
    </div>
</div>

<div class="controls">
    <div class="bet-container">
        <button class="bet-btn" onclick="adjustBet(-5)">-</button>
        <div class="bet-display"><span id="betAmount">10</span></div>
        <button class="bet-btn" onclick="adjustBet(5)">+</button>
    </div>
    
    <button id="spin-btn">SPIN</button>
    
    <div id="freeSpinLabel" style="color:var(--rasta-green); font-weight:bold; display:none;">
        FREE SPINS LEFT: <span id="fsCount">0</span>
    </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzdPewsjld31mT1oBLhtCk_bkM5B_iVcaOeTMJUFMPxqgyH2bFJVYZIFTcZrPgxBrID/exec";
const symbols = [
    { name: "cherry", img: "cherry.png", val: 2 },
    { name: "lemon", img: "lemon.png", val: 3 },
    { name: "orange", img: "orange.png", val: 5 },
    { name: "grape", img: "grape.png", val: 10 },
    { name: "watermelon", img: "watermelon.png", val: 20 },
    { name: "wild", img: "wild.png", val: 50 }
];

let currentBet = 10;
let isSpinning = false;
let freeSpins = 0;
let userData = JSON.parse(localStorage.getItem('rasta_user'));

// Init Reels
function init() {
    if(!userData) window.location.href = 'index.html';
    document.getElementById('userBal').innerText = parseFloat(userData.balance).toFixed(2);
    
    for(let i=0; i<3; i++) {
        const container = document.getElementById(`reel${i}`);
        // Populate with many symbols for scrolling effect
        for(let s=0; s<30; s++) {
            const sym = symbols[Math.floor(Math.random()*symbols.length)];
            const div = document.createElement('div');
            div.className = 'symbol';
            div.innerHTML = `<img src="asset/${sym.img}">`;
            container.appendChild(div);
        }
    }
}

function adjustBet(amt) {
    if(isSpinning) return;
    currentBet = Math.max(5, Math.min(1000, currentBet + amt));
    document.getElementById('betAmount').innerText = currentBet;
}

async function updateDatabase(newBalance, winAmount = 0) {
    const phone = userData.phone || userData.phoneNumber;
    try {
        await fetch(`${SCRIPT_URL}?action=updateBalance&phone=${phone}&balance=${newBalance}`);
        userData.balance = newBalance;
        localStorage.setItem('rasta_user', JSON.stringify(userData));
        document.getElementById('userBal').innerText = parseFloat(newBalance).toFixed(2);
    } catch(e) { console.error("Sync Error"); }
}

async function spin() {
    if(isSpinning) return;
    
    if(freeSpins <= 0) {
        if(userData.balance < currentBet) {
            alert("Insufficient Balance!");
            return;
        }
        userData.balance -= currentBet;
        updateDatabase(userData.balance);
    } else {
        freeSpins--;
        updateFSDisplay();
    }

    isSpinning = true;
    document.getElementById('spin-btn').disabled = true;
    document.getElementById('winMsg').style.display = 'none';
    clearCanvas();

    const results = [];
    const reelPromises = [];

    for(let i=0; i<3; i++) {
        const reel = document.getElementById(`reel${i}`);
        const stopIdx = Math.floor(Math.random() * symbols.length);
        results.push(stopIdx);

        // Animation logic
        reel.style.transition = 'none';
        reel.style.transform = 'translateY(0)';
        
        reelPromises.push(new Promise(resolve => {
            setTimeout(() => {
                reel.style.transition = `transform ${2 + i*0.5}s cubic-bezier(0.45, 0.05, 0.55, 0.95)`;
                // Scroll down to the symbol (each symbol is 90px)
                const targetY = -( (20 * 90) + (stopIdx * 90) );
                reel.style.transform = `translateY(${targetY}px)`;
                setTimeout(resolve, 2500 + i*500);
            }, 50);
        }));
    }

    await Promise.all(reelPromises);
    checkWin(results);
}

function checkWin(results) {
    let winAmt = 0;
    const s1 = symbols[results[0]];
    const s2 = symbols[results[1]];
    const s3 = symbols[results[2]];

    // 3 of a kind
    if(s1.name === s2.name && s2.name === s3.name) {
        winAmt = currentBet * s1.val;
    } 
    // Wild logic (if you have one wild, it doubles)
    else if(s1.name === "wild" || s2.name === "wild" || s3.name === "wild") {
        if(s1.name === s2.name || s2.name === s3.name || s1.name === s3.name) {
            winAmt = currentBet * 2;
        }
    }

    // Random Free Spin chance
    if(Math.random() > 0.9) {
        freeSpins += 3;
        showWin("3 FREE SPINS!");
        updateFSDisplay();
    }

    if(winAmt > 0) {
        userData.balance += winAmt;
        updateDatabase(userData.balance, winAmt);
        showWin(`WIN: ${winAmt} ETB`);
        createConfetti();
    }

    isSpinning = false;
    document.getElementById('spin-btn').disabled = false;
    
    // Auto-play free spins
    if(freeSpins > 0) {
        setTimeout(spin, 2000);
    }
}

function showWin(txt) {
    const m = document.getElementById('winMsg');
    m.innerText = txt;
    m.style.display = 'block';
}

function updateFSDisplay() {
    const label = document.getElementById('freeSpinLabel');
    if(freeSpins > 0) {
        label.style.display = 'block';
        document.getElementById('fsCount').innerText = freeSpins;
    } else {
        label.style.display = 'none';
    }
}

function clearCanvas() {
    const canvas = document.getElementById('lineCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0, canvas.width, canvas.height);
}

function createConfetti() {
    for(let i=0; i<50; i++) {
        const p = document.createElement('div');
        p.className = 'confetti-piece';
        p.style.left = Math.random()*100+'%';
        p.style.top = '-10px';
        p.style.backgroundColor = ['#FFD100','#008542','#E71D36'][Math.floor(Math.random()*3)];
        document.body.appendChild(p);
        
        let y = -10;
        let x = Math.random()*2 - 1;
        const anim = setInterval(() => {
            y += 5;
            p.style.top = y + 'px';
            p.style.left = (parseFloat(p.style.left) + x) + '%';
            if(y > window.innerHeight) {
                clearInterval(anim);
                p.remove();
            }
        }, 20);
    }
}

document.getElementById('spin-btn').addEventListener('click', spin);
window.onload = init;
</script>

</body>
</html>
