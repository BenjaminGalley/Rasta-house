<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FAST KENO 80 | RASTA</title>
    <link href="https://fonts.googleapis.com/css2?family=Goldman&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --rasta-green: #008542; --rasta-gold: #FFD100; --rasta-red: #E71D36; --dark: #0a0a0a; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        body { background: var(--dark); color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- HEADER --- */
        .header {
            background: #000; padding: 10px 15px; border-bottom: 3px solid var(--rasta-gold);
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo-80 {
            background: var(--rasta-red); color: white; padding: 5px 10px; border-radius: 5px;
            font-family: 'Goldman'; font-weight: 900; border: 2px solid var(--rasta-gold);
        }
        .timer-display { font-family: 'Goldman'; color: var(--rasta-red); font-size: 1.4rem; text-shadow: 0 0 10px rgba(231,29,54,0.5); }

        /* --- MAIN GAME AREA --- */
        .game-layout { display: flex; flex: 1; overflow: hidden; background: #111; }

        /* Left Side: Draw Board */
        .side-board {
            width: 80px; background: #000; border-right: 2px solid #333;
            display: flex; flex-direction: column; align-items: center; padding-top: 10px;
            overflow-y: auto; gap: 5px;
        }
        .draw-ball {
            width: 45px; height: 45px; background: radial-gradient(circle at 30% 30%, #555, #000);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 900; border: 2px solid #444; font-size: 1.1rem; color: #fff;
            animation: slideIn 0.3s ease-out forwards;
        }
        .draw-ball.active { border-color: var(--rasta-gold); background: radial-gradient(circle at 30% 30%, var(--rasta-red), #600); }

        /* Center: Grid */
        .grid-container { flex: 1; padding: 10px; display: flex; flex-direction: column; align-items: center; position: relative; }
        .keno-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; width: 100%; max-width: 500px; }
        .num { 
            background: #222; border: 1px solid #444; aspect-ratio: 1; display: flex; 
            align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; border-radius: 4px;
        }
        .num.selected { background: var(--rasta-gold); color: #000; }
        .num.hit { background: var(--rasta-red) !important; color: white; animation: popBall 0.5s ease-out; }
        .num.match { background: var(--rasta-green) !important; box-shadow: 0 0 15px var(--rasta-green); }

        /* Big Pop Reveal Overlay */
        #big-reveal {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 120px; height: 120px; background: white; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: 900; color: #000; border: 8px solid var(--rasta-gold);
            z-index: 100; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        /* --- TICKETS --- */
        .tray { height: 140px; background: #000; border-top: 2px solid #333; display: flex; overflow-x: auto; padding: 10px; gap: 10px; }
        .ticket {
            min-width: 150px; border: 1px dashed var(--rasta-gold); border-radius: 8px;
            padding: 8px; font-size: 0.75rem; background: #0a0a0a; position: relative;
        }
        .ticket b { color: var(--rasta-gold); }
        .ticket-num { display: inline-block; width: 22px; text-align: center; margin: 1px; border-radius: 3px; background: #222; }
        .ticket-num.hit { background: var(--rasta-green); color: white; font-weight: bold; }
        .ticket.won-card { border: 2px solid var(--rasta-green); background: rgba(0, 133, 66, 0.2); }

        /* --- CONTROLS --- */
        .controls { background: #000; padding: 15px; border-top: 2px solid var(--rasta-gold); display: flex; gap: 10px; align-items: center; }
        #betBtn { flex: 1; padding: 15px; background: var(--rasta-green); border: none; border-radius: 10px; color: white; font-weight: 900; font-size: 1.2rem; cursor: pointer; }
        #betBtn:disabled { background: #333; }
        .stake-input { background: #111; border: 1px solid var(--rasta-gold); color: var(--rasta-gold); padding: 12px; width: 80px; border-radius: 10px; text-align: center; font-weight: bold; }

        #win-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
        }

        @keyframes popBall { 0% { transform: scale(1); } 50% { transform: scale(1.6); } 100% { transform: scale(1); } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="win-overlay">
    <h1 id="win-status" style="font-size: 3rem; color: var(--rasta-gold);">WON 500 ETB</h1>
    <p style="color: white;">NEXT ROUND STARTING...</p>
</div>

<div class="header">
    <div onclick="location.href='index.html'" style="cursor:pointer">üè†</div>
    <div class="logo-80">KENO 80</div>
    <div class="timer-display" id="timer">00:60</div>
    <div style="color: var(--rasta-green); font-weight: bold;" id="balance">0.00</div>
</div>

<div class="game-layout">
    <div class="side-board" id="sideBoard">
        </div>
    <div class="grid-container">
        <div id="big-reveal">00</div>
        <div class="keno-grid" id="grid"></div>
    </div>
</div>

<div class="tray" id="ticketTray">
    <div style="color:#444; width:100%; text-align:center; padding-top:40px;">No bets placed.</div>
</div>

<div class="controls">
    <input type="number" class="stake-input" id="stake" value="10">
    <button id="betBtn" onclick="placeBet()">PLACE BET</button>
</div>

<audio id="snd-pop"><source src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" type="audio/ogg"></audio>
<audio id="snd-win"><source src="https://actions.google.com/sounds/v1/foley/beating_prizes.ogg" type="audio/ogg"></audio>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzdPewsjld31mT1oBLhtCk_bkM5B_iVcaOeTMJUFMPxqgyH2bFJVYZIFTcZrPgxBrID/exec";
    let user = JSON.parse(localStorage.getItem('rasta_user')) || { balance: 0, phone: "000" };
    let selected = [];
    let tickets = [];
    let timeLeft = 60;
    let drawing = false;

    const payouts = { 2: 5, 3: 15, 4: 50, 5: 150, 6: 500, 7: 1500, 8: 4000, 9: 10000, 10: 25000 };

    function initGrid() {
        const grid = document.getElementById('grid');
        for(let i=1; i<=80; i++) {
            let div = document.createElement('div');
            div.className = 'num';
            div.innerText = i;
            div.id = 'n-' + i;
            div.onclick = () => selectNum(i);
            grid.appendChild(div);
        }
        updateUI();
        syncBalance();
    }

    async function syncBalance() {
        try {
            const res = await fetch(`${SCRIPT_URL}?action=login&phone=${user.phone}&t=${Date.now()}`);
            const data = await res.json();
            if(data.balance) { user.balance = data.balance; updateUI(); }
        } catch(e) {}
    }

    function selectNum(n) {
        if(drawing) return;
        const el = document.getElementById('n-'+n);
        if(selected.includes(n)) {
            selected = selected.filter(x => x !== n);
            el.classList.remove('selected');
        } else if(selected.length < 10) {
            selected.push(n);
            el.classList.add('selected');
        }
    }

    function updateUI() {
        document.getElementById('balance').innerText = parseFloat(user.balance).toFixed(2) + " ETB";
        localStorage.setItem('rasta_user', JSON.stringify(user));
    }

    function placeBet() {
        let stake = parseFloat(document.getElementById('stake').value);
        if(selected.length < 2) return alert("Select 2-10 numbers!");
        if(user.balance < stake) return alert("Low Balance!");

        user.balance -= stake;
        updateUI();

        let tId = Math.floor(Math.random()*900)+100;
        let newTicket = { id: tId, nums: [...selected], stake: stake, hits: 0 };
        tickets.push(newTicket);

        renderTickets();
        
        // Clear selection immediately for next bet
        selected = [];
        document.querySelectorAll('.num').forEach(n => n.classList.remove('selected'));
        document.getElementById('snd-pop').play();
    }

    function renderTickets() {
        const tray = document.getElementById('ticketTray');
        if(tickets.length === 0) {
            tray.innerHTML = '<div style="color:#444; width:100%; text-align:center; padding-top:40px;">No bets placed.</div>';
            return;
        }
        tray.innerHTML = '';
        tickets.forEach(t => {
            let html = `<div class="ticket" id="t-${t.id}">
                <b>#${t.id}</b> | Stake: ${t.stake}<br><div style="margin-top:5px">`;
            t.nums.forEach(n => {
                html += `<span class="ticket-num" id="tn-${t.id}-${n}">${n}</span>`;
            });
            html += `</div><div id="res-${t.id}" style="font-weight:bold; margin-top:5px; color:var(--rasta-gold)">Waiting...</div></div>`;
            tray.innerHTML += html;
        });
    }

    // Main Timer
    setInterval(() => {
        if(drawing) return;
        timeLeft--;
        if(timeLeft <= 0) {
            runDraw();
            timeLeft = 60;
        }
        document.getElementById('timer').innerText = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
        document.getElementById('betBtn').disabled = (timeLeft <= 5);
    }, 1000);

    async function runDraw() {
        drawing = true;
        let drawn = [];
        const sideBoard = document.getElementById('sideBoard');
        const bigReveal = document.getElementById('big-reveal');
        sideBoard.innerHTML = '';

        while(drawn.length < 20) {
            let r = Math.floor(Math.random()*80)+1;
            if(!drawn.includes(r)) drawn.push(r);
        }

        for(let i=0; i<drawn.length; i++) {
            let n = drawn[i];
            
            // 1. Big Center Reveal
            bigReveal.innerText = n;
            bigReveal.style.display = 'flex';
            document.getElementById('snd-pop').play();

            // 2. Mark Grid
            let gridNum = document.getElementById('n-'+n);
            gridNum.classList.add('hit');

            // 3. Side Board
            let ball = document.createElement('div');
            ball.className = 'draw-ball active';
            ball.innerText = n;
            sideBoard.prepend(ball);

            // 4. Update Tickets & Mark Matches
            tickets.forEach(t => {
                if(t.nums.includes(n)) {
                    t.hits++;
                    gridNum.classList.add('match');
                    let tNum = document.getElementById(`tn-${t.id}-${n}`);
                    if(tNum) tNum.classList.add('hit');
                }
            });

            await new Promise(r => setTimeout(r, 800)); // Sync speed (0.8s)
            bigReveal.style.display = 'none';
        }

        checkFinalResults();
    }

    function checkFinalResults() {
        let totalWon = 0;
        tickets.forEach(t => {
            let winMult = (t.hits === t.nums.length) ? payouts[t.nums.length] : 0;
            let winAmt = t.stake * winMult;
            let resEl = document.getElementById(`res-${t.id}`);
            let cardEl = document.getElementById(`t-${t.id}`);

            if(winAmt > 0) {
                totalWon += winAmt;
                resEl.innerText = "WON " + winAmt + " ETB";
                cardEl.classList.add('won-card');
            } else {
                resEl.innerText = "NO WIN";
            }
        });

        const overlay = document.getElementById('win-overlay');
        const status = document.getElementById('win-status');
        overlay.style.display = 'flex';

        if(totalWon > 0) {
            status.innerText = "WON " + totalWon + " ETB";
            status.style.color = "var(--rasta-gold)";
            document.getElementById('snd-win').play();
            user.balance += totalWon;
        } else {
            status.innerText = "TRY AGAIN";
            status.style.color = "white";
        }

        updateUI();
        saveToDB();

        setTimeout(() => {
            overlay.style.display = 'none';
            resetTable();
        }, 5000);
    }

    function resetTable() {
        tickets = [];
        drawing = false;
        document.querySelectorAll('.num').forEach(n => n.classList.remove('hit', 'match', 'selected'));
        document.getElementById('sideBoard').innerHTML = '';
        renderTickets();
    }

    function saveToDB() {
        fetch(`${SCRIPT_URL}?action=login&phone=${user.phone}&updateBal=${user.balance}`);
    }

    window.onload = initGrid;
</script>
</body>
</html>
