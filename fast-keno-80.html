<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FAST KENO 80 | RASTA</title>
    <link href="https://fonts.googleapis.com/css2?family=Goldman&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --rasta-green: #008542; --rasta-gold: #FFD100; --rasta-red: #E71D36; --dark: #0a0a0a; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        body { background: var(--dark); color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- HEADER --- */
        .header {
            background: #000; padding: 10px 15px; border-bottom: 3px solid var(--rasta-gold);
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }
        .logo-80 {
            background: var(--rasta-red); color: white; padding: 5px 10px; border-radius: 5px;
            font-family: 'Goldman'; font-weight: 900; border: 2px solid var(--rasta-gold);
        }
        .timer-display { font-family: 'Goldman'; color: var(--rasta-red); font-size: 1.4rem; }
        .bal-box { background: #111; padding: 5px 12px; border-radius: 20px; border: 1px solid var(--rasta-green); font-weight: 900; color: var(--rasta-green); }

        /* --- MAIN GAME AREA --- */
        .game-layout { display: flex; flex: 1; overflow: hidden; background: #111; position: relative; }

        .side-board {
            width: 60px; background: #000; border-right: 2px solid #333;
            display: flex; flex-direction: column; align-items: center; padding-top: 10px;
            overflow-y: auto; gap: 5px;
        }
        .draw-ball {
            width: 35px; height: 35px; background: radial-gradient(circle at 30% 30%, #555, #000);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 900; border: 2px solid #444; font-size: 0.9rem; color: #fff;
            animation: slideIn 0.3s ease-out forwards;
        }
        .draw-ball.active { border-color: var(--rasta-gold); background: radial-gradient(circle at 30% 30%, var(--rasta-red), #600); }

        .grid-container { flex: 1; padding: 5px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .keno-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; width: 100%; max-width: 400px; }
        .num { 
            background: #222; border: 1px solid #444; aspect-ratio: 1; display: flex; 
            align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; border-radius: 4px; cursor: pointer;
        }
        .num.selected { background: var(--rasta-gold); color: #000; box-shadow: 0 0 10px var(--rasta-gold); }
        .num.hit { background: var(--rasta-red) !important; color: white; animation: popBall 0.5s ease-out; }
        .num.match { background: var(--rasta-green) !important; box-shadow: 0 0 15px var(--rasta-green); border-color: white; }

        /* Potential Win Display */
        .info-bar { 
            width: 100%; max-width: 400px; padding: 8px; margin-top: 5px; 
            background: rgba(0,0,0,0.5); border-radius: 5px; border-left: 4px solid var(--rasta-gold);
            font-size: 0.8rem; display: flex; justify-content: space-between;
        }

        #big-reveal {
            position: absolute; top: 40%; left: 55%; transform: translate(-50%, -50%);
            width: 100px; height: 100px; background: white; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            font-size: 2.5rem; font-weight: 900; color: #000; border: 6px solid var(--rasta-gold);
            z-index: 100; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        /* --- TICKETS --- */
        .tray { min-height: 80px; background: #000; border-top: 2px solid #333; display: flex; overflow-x: auto; padding: 10px; gap: 10px; }
        .ticket {
            min-width: 140px; border: 1px dashed var(--rasta-gold); border-radius: 8px;
            padding: 8px; font-size: 0.7rem; background: #0a0a0a; flex-shrink: 0;
        }
        .ticket-num { display: inline-block; width: 20px; text-align: center; margin: 1px; border-radius: 3px; background: #222; }
        .ticket-num.hit { background: var(--rasta-green); color: white; }

        /* --- CONTROLS --- */
        .controls { 
            background: #000; padding: 10px 15px 25px 15px; border-top: 2px solid var(--rasta-gold); 
            display: flex; flex-direction: column; gap: 8px; 
        }
        .bet-bar { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .step-btn {
            width: 45px; height: 45px; border-radius: 10px; border: 2px solid var(--rasta-gold);
            background: #222; color: var(--rasta-gold); font-size: 1.5rem; font-weight: bold; cursor: pointer;
        }
        .stake-display { flex: 1; background: #111; border: 1px solid #444; border-radius: 10px; display: flex; flex-direction: column; align-items: center; padding: 5px; }
        .stake-display small { font-size: 0.6rem; color: #888; text-transform: uppercase; }
        .stake-display b { color: var(--rasta-gold); font-size: 1.2rem; }

        #betBtn { 
            width: 100%; padding: 15px; background: var(--rasta-green); border: none; 
            border-radius: 10px; color: white; font-weight: 900; font-size: 1.2rem; 
            cursor: pointer; box-shadow: 0 4px 0 #004d26;
        }
        #betBtn:active { transform: translateY(2px); box-shadow: 0 2px 0 #004d26; }
        #betBtn:disabled { background: #333; box-shadow: none; transform: none; opacity: 0.6; }

        #win-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
        }

        @keyframes popBall { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="win-overlay">
    <h1 id="win-status" style="font-size: 2.5rem; color: var(--rasta-gold); text-align: center;"></h1>
    <p style="color: white; margin-top: 10px;">PREPARING NEXT ROUND...</p>
</div>

<div class="header">
    <div onclick="location.href='index.html'" style="cursor:pointer; font-size: 1.2rem;">üè†</div>
    <div class="logo-80">KENO 80</div>
    <div class="timer-display" id="timer">00:60</div>
    <div class="bal-box" id="balance">0.00</div>
</div>

<div class="game-layout">
    <div class="side-board" id="sideBoard"></div>
    <div class="grid-container">
        <div id="big-reveal">00</div>
        <div class="keno-grid" id="grid"></div>
        <div class="info-bar" id="potential-win-box">
            <span>Selected: <b id="sel-count" style="color:var(--rasta-gold)">0</b></span>
            <span>Potential Win: <b id="pot-win" style="color:var(--rasta-green)">0.00 ETB</b></span>
        </div>
    </div>
</div>

<div class="tray" id="ticketTray">
    <div style="color:#444; width:100%; text-align:center; align-self: center;">No tickets active.</div>
</div>

<div class="controls">
    <div class="bet-bar">
        <button class="step-btn" onclick="adjustBet(-2)">-</button>
        <div class="stake-display">
            <small>Stake Amount</small>
            <b id="stakeVal">2</b>
        </div>
        <button class="step-btn" onclick="adjustBet(2)">+</button>
    </div>
    <button id="betBtn" onclick="placeBet()">PLACE BET</button>
</div>

<audio id="snd-pop"><source src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" type="audio/ogg"></audio>
<audio id="snd-win"><source src="https://actions.google.com/sounds/v1/foley/beating_prizes.ogg" type="audio/ogg"></audio>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzdPewsjld31mT1oBLhtCk_bkM5B_iVcaOeTMJUFMPxqgyH2bFJVYZIFTcZrPgxBrID/exec";
    let user = JSON.parse(localStorage.getItem('rasta_user')) || { balance: 0, phone: "000" };
    let selected = [];
    let tickets = [];
    let timeLeft = 60;
    let drawing = false;
    let currentStake = 2; // Min bet set to 2

    // Keno Payout Multipliers (per 1 ETB staked)
    const multipliers = {
        2: 5, 3: 15, 4: 50, 5: 150, 6: 500, 7: 1500, 8: 4000, 9: 10000, 10: 25000
    };

    function initGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        for(let i=1; i<=80; i++) {
            let div = document.createElement('div');
            div.className = 'num';
            div.innerText = i;
            div.id = 'n-' + i;
            div.onclick = () => selectNum(i);
            grid.appendChild(div);
        }
        updateUI();
        syncWithServer();
    }

    function adjustBet(amt) {
        if(drawing) return;
        currentStake = Math.max(2, currentStake + amt);
        document.getElementById('stakeVal').innerText = currentStake;
        updatePotentialWin();
    }

    async function syncWithServer() {
        try {
            const res = await fetch(`${SCRIPT_URL}?action=login&phone=${user.phone}`);
            const data = await res.json();
            if(data.balance !== undefined) { 
                user.balance = parseFloat(data.balance); 
                updateUI(); 
            }
        } catch(e) { console.log("Sync failed"); }
    }

    function selectNum(n) {
        if(drawing || timeLeft <= 5) return;
        const el = document.getElementById('n-'+n);
        if(selected.includes(n)) {
            selected = selected.filter(x => x !== n);
            el.classList.remove('selected');
        } else if(selected.length < 10) {
            selected.push(n);
            el.classList.add('selected');
        }
        updatePotentialWin();
    }

    function updatePotentialWin() {
        const count = selected.length;
        document.getElementById('sel-count').innerText = count;
        
        let potential = 0;
        if(count >= 2) {
            potential = currentStake * multipliers[count];
        }
        document.getElementById('pot-win').innerText = potential.toFixed(2) + " ETB";
        
        // Disable button if count < 2
        document.getElementById('betBtn').disabled = (timeLeft <= 5 || count < 2);
    }

    function updateUI() {
        document.getElementById('balance').innerText = parseFloat(user.balance).toFixed(2) + " ETB";
        localStorage.setItem('rasta_user', JSON.stringify(user));
    }

    function placeBet() {
        if(selected.length < 2) return alert("Select at least 2 numbers!");
        if(user.balance < currentStake) return alert("Insufficient Balance!");

        user.balance -= currentStake;
        updateUI();
        saveToDB();

        let tId = Math.floor(Math.random()*9000)+1000;
        tickets.push({ id: tId, nums: [...selected], stake: currentStake, hits: 0 });

        renderTickets();
        selected = [];
        document.querySelectorAll('.num').forEach(n => n.classList.remove('selected'));
        updatePotentialWin();
        document.getElementById('snd-pop').play();
    }

    function renderTickets() {
        const tray = document.getElementById('ticketTray');
        if(tickets.length === 0) {
            tray.innerHTML = '<div style="color:#444; width:100%; text-align:center; align-self: center;">No tickets active.</div>';
            return;
        }
        tray.innerHTML = '';
        tickets.forEach(t => {
            let html = `<div class="ticket" id="t-${t.id}">
                <b style="color:var(--rasta-gold)">#${t.id}</b> | Bet: ${t.stake}<br><div style="margin-top:5px">`;
            t.nums.forEach(n => {
                html += `<span class="ticket-num" id="tn-${t.id}-${n}">${n}</span>`;
            });
            html += `</div><div id="res-${t.id}" style="font-weight:bold; margin-top:5px; font-size:0.6rem;">PENDING...</div></div>`;
            tray.innerHTML += html;
        });
    }

    setInterval(() => {
        if(drawing) return;
        timeLeft--;
        if(timeLeft <= 0) {
            runDraw();
            timeLeft = 60;
        }
        document.getElementById('timer').innerText = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
        document.getElementById('betBtn').disabled = (timeLeft <= 5 || selected.length < 2);
    }, 1000);

    async function runDraw() {
        drawing = true;
        let drawn = [];
        const sideBoard = document.getElementById('sideBoard');
        const bigReveal = document.getElementById('big-reveal');
        sideBoard.innerHTML = '';

        while(drawn.length < 20) {
            let r = Math.floor(Math.random()*80)+1;
            if(!drawn.includes(r)) drawn.push(r);
        }

        for(let i=0; i<drawn.length; i++) {
            let n = drawn[i];
            bigReveal.innerText = n;
            bigReveal.style.display = 'flex';
            document.getElementById('snd-pop').play();

            let gridNum = document.getElementById('n-'+n);
            if(gridNum) gridNum.classList.add('hit');

            let ball = document.createElement('div');
            ball.className = 'draw-ball active';
            ball.innerText = n;
            sideBoard.prepend(ball);

            tickets.forEach(t => {
                if(t.nums.includes(n)) {
                    t.hits++;
                    if(gridNum) gridNum.classList.add('match');
                    let tNum = document.getElementById(`tn-${t.id}-${n}`);
                    if(tNum) tNum.classList.add('hit');
                }
            });

            await new Promise(r => setTimeout(r, 800));
            bigReveal.style.display = 'none';
        }
        checkResults();
    }

    function checkResults() {
        let totalWin = 0;
        tickets.forEach(t => {
            let winAmt = 0;
            // Standard Rasta Keno: Must match ALL selected numbers to win big
            if(t.hits === t.nums.length && multipliers[t.hits]) {
                winAmt = t.stake * multipliers[t.hits];
            }

            if(winAmt > 0) {
                totalWin += winAmt;
                document.getElementById(`res-${t.id}`).innerText = "WIN: " + winAmt.toFixed(2);
                document.getElementById(`res-${t.id}`).style.color = "var(--rasta-green)";
            } else {
                document.getElementById(`res-${t.id}`).innerText = "LOSE";
                document.getElementById(`res-${t.id}`).style.color = "gray";
            }
        });

        if(totalWin > 0) {
            user.balance += totalWin;
            document.getElementById('win-status').innerText = "TOTAL WIN\n" + totalWin.toFixed(2) + " ETB";
            document.getElementById('snd-win').play();
        } else {
            document.getElementById('win-status').innerText = "NO LUCK THIS TIME";
            document.getElementById('win-status').style.color = "white";
        }

        document.getElementById('win-overlay').style.display = 'flex';
        updateUI();
        saveToDB();

        setTimeout(() => {
            document.getElementById('win-overlay').style.display = 'none';
            resetRound();
        }, 5000);
    }

    function resetRound() {
        tickets = [];
        drawing = false;
        document.querySelectorAll('.num').forEach(n => n.classList.remove('hit', 'match', 'selected'));
        document.getElementById('sideBoard').innerHTML = '';
        renderTickets();
        updatePotentialWin();
    }

    function saveToDB() {
        fetch(`${SCRIPT_URL}?action=login&phone=${user.phone}&updateBal=${user.balance}`);
    }

    window.onload = initGrid;
</script>
</body>
</html>
