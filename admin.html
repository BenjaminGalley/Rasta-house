<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RASTA ADMIN | MASTER</title>
    <style>
        :root { --green: #008542; --gold: #FFD100; --red: #E71D36; }
        body { background: #000; color: white; font-family: 'Segoe UI', sans-serif; padding: 15px; margin: 0; }
        
        /* LOGIN OVERLAY */
        #admin-lock {
            position: fixed; top:0; left:0; width:100%; height:100%; background:#000;
            display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;
        }
        .lock-input { padding:15px; border-radius:8px; border:1px solid var(--gold); background:#111; color:white; font-size:1.2rem; text-align:center; margin-bottom:10px; }

        .header { text-align: center; border-bottom: 2px solid var(--gold); padding: 20px; margin-bottom: 20px; }
        .card { background: #111; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; position: relative; }
        .dep-card { border-left: 6px solid var(--green); }
        .wit-card { border-left: 6px solid var(--red); }
        
        .label { color: #888; font-size: 0.7rem; display: block; margin-top: 8px; text-transform: uppercase; }
        .val { color: var(--gold); font-weight: bold; font-size: 1rem; display: block; }
        .amt { font-size: 1.8rem; font-weight: bold; margin: 10px 0; color: white; display: flex; align-items: center; justify-content: space-between; }
        
        .method-tag { font-size: 0.7rem; padding: 3px 8px; background: #222; border-radius: 5px; color: #ccc; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        .btn-app { background: var(--green); color: white; }
        .btn-pay { background: var(--gold); color: black; }
        .btn-refresh { background: #222; color: white; border: 1px solid #444; margin-bottom: 20px; }
        
        #loading-ui { text-align: center; color: var(--gold); padding: 20px; display: none; position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); border: 1px solid var(--gold); border-radius: 5px; z-index: 10000; }
    </style>
</head>
<body>

    <div id="admin-lock">
        <h2 style="color:var(--gold)">RASTA ADMIN ACCESS</h2>
        <input type="password" id="adminPass" class="lock-input" placeholder="Enter Admin Pin">
        <button class="btn btn-app" style="width:200px" onclick="checkLock()">LOGIN</button>
    </div>

    <div id="admin-content" style="display:none;">
        <div class="header">
            <h2 style="color:var(--gold); margin:0;">RASTA ADMIN PANEL</h2>
            <p style="font-size:0.8rem; color:var(--green)">HOUSE MANAGEMENT SYSTEM</p>
        </div>

        <button class="btn btn-refresh" onclick="load()">üîÑ REFRESH DATA / ·ä†·ãµ·àµ</button>
        <div id="loading-ui">PROCESSING...</div>

        <h3 style="color:var(--green)">üì• PENDING REQUESTS (·åà·â¢ ·ä•·äì ·ãà·å™ ·å•·ã´·âÑ·ãé·âΩ)</h3>
        <div id="request-list">Fetching...</div>
    </div>

    <script>
        // NEW DEPLOYED SCRIPT URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyctgyddXtB4E4GjNlm5dygmh-RI960Fa8qqa4rY7WarCZAZ0wb8VNQXtzulFh7dvAm/exec";

        function checkLock() {
            const pin = document.getElementById('adminPass').value;
            if(pin === '333') {
                document.getElementById('admin-lock').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                load();
            } else {
                alert("Wrong Pin!");
            }
        }

        async function load() {
            document.getElementById('loading-ui').style.display = 'block';
            try {
                // Simba Logic: getPending fetches rows from Sheet1
                const res = await fetch(`${SCRIPT_URL}?action=getPending&t=${Date.now()}`);
                const data = await res.json();

                let listHtml = '';
                if(data && data.length > 0) {
                    data.forEach(item => {
                        const isDeposit = item.type === "DEPOSIT";
                        const cardClass = isDeposit ? "dep-card" : "wit-card";
                        const btnText = isDeposit ? "APPROVE DEPOSIT ‚úÖ" : "MARK AS PAID üí∏";
                        const btnClass = isDeposit ? "btn-app" : "btn-pay";
                        
                        listHtml += `<div class="card ${cardClass}">
                            <span class="label">PLAYER NAME (·ã®·ã∞·äï·â†·äõ·ãç ·àµ·àù):</span> 
                            <span class="val">${item.name || 'Unknown'}</span>
                            
                            <span class="label">PLAYER PHONE (·ã®·ã∞·äï·â†·äõ·ãç ·àµ·àç·ä≠):</span> 
                            <span class="val">${item.phone}</span>
                            
                            <span class="label">TRANSACTION TYPE (·ã®·å•·ã´·âÑ ·ä†·ã≠·äê·âµ):</span> 
                            <span class="val" style="color:${isDeposit ? 'var(--green)' : 'var(--red)'}">${item.type}</span>
                            
                            <span class="label">DETAILS (·ãù·à≠·ãù·à≠):</span> 
                            <span class="val">${item.details || 'No details provided'}</span>
                            
                            <div class="amt">
                                <span>${parseFloat(item.amount).toFixed(2)} ETB</span>
                                <span class="method-tag">Sheet Row: ${item.row}</span>
                            </div>
                            
                            <button class="btn ${btnClass}" onclick="handleAction('${item.row}', '${item.type}', '${item.amount}')">${btnText}</button>
                        </div>`;
                    });
                }
                document.getElementById('request-list').innerHTML = listHtml || "<p style='color:#666; text-align:center;'>No pending requests</p>";

            } catch(e) {
                console.error(e);
                alert("Error loading data. Check Connection.");
            }
            document.getElementById('loading-ui').style.display = 'none';
        }

        async function handleAction(row, type, amount) {
            const confirmMsg = type === "DEPOSIT" 
                ? `Confirm: Add ${amount} ETB to player's balance?` 
                : `Confirm: Mark withdrawal as Paid? (Balance already deducted)`;
            
            if(!confirm(confirmMsg)) return;

            document.getElementById('loading-ui').style.display = 'block';
            try {
                // In your Google Script, action=approve handles the balance math using the row index
                const res = await fetch(`${SCRIPT_URL}?action=approve&row=${row}&t=${Date.now()}`);
                const result = await res.text();
                
                if(result === "SUCCESS") {
                    alert("Action Completed Successfully!");
                    load();
                } else {
                    alert("System Response: " + result);
                    load();
                }
            } catch(e) {
                alert("Request Sent! Refreshing...");
                setTimeout(load, 1500);
            }
            document.getElementById('loading-ui').style.display = 'none';
        }
    </script>
</body>
</html>
