<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RASTA ADMIN | MASTER</title>
    <style>
        :root { --green: #008542; --gold: #FFD100; --red: #E71D36; }
        body { background: #000; color: white; font-family: 'Segoe UI', sans-serif; padding: 15px; margin: 0; }
        
        /* LOGIN OVERLAY */
        #admin-lock {
            position: fixed; top:0; left:0; width:100%; height:100%; background:#000;
            display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;
        }
        .lock-input { padding:15px; border-radius:8px; border:1px solid var(--gold); background:#111; color:white; font-size:1.2rem; text-align:center; margin-bottom:10px; }

        .header { text-align: center; border-bottom: 2px solid var(--gold); padding: 20px; margin-bottom: 20px; }
        .card { background: #111; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; position: relative; }
        .dep-card { border-left: 6px solid var(--green); }
        .wit-card { border-left: 6px solid var(--red); }
        
        .label { color: #888; font-size: 0.7rem; display: block; margin-top: 8px; text-transform: uppercase; }
        .val { color: var(--gold); font-weight: bold; font-size: 1rem; display: block; }
        .amt { font-size: 1.8rem; font-weight: bold; margin: 10px 0; color: white; display: flex; align-items: center; justify-content: space-between; }
        
        .method-tag { font-size: 0.7rem; padding: 3px 8px; background: #222; border-radius: 5px; color: #ccc; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        .btn-app { background: var(--green); color: white; }
        .btn-pay { background: var(--gold); color: black; }
        .btn-refresh { background: #222; color: white; border: 1px solid #444; margin-bottom: 20px; }
        
        #loading-ui { text-align: center; color: var(--gold); padding: 20px; display: none; position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); border: 1px solid var(--gold); border-radius: 5px; z-index: 10000; }
    </style>
</head>
<body>

    <div id="admin-lock">
        <h2 style="color:var(--gold)">RASTA ADMIN ACCESS</h2>
        <input type="password" id="adminPass" class="lock-input" placeholder="Enter Admin Pin">
        <button class="btn btn-app" style="width:200px" onclick="checkLock()">LOGIN</button>
    </div>

    <div id="admin-content" style="display:none;">
        <div class="header">
            <h2 style="color:var(--gold); margin:0;">RASTA ADMIN PANEL</h2>
            <p style="font-size:0.8rem; color:var(--green)">HOUSE MANAGEMENT SYSTEM</p>
        </div>

        <button class="btn btn-refresh" onclick="load()">üîÑ REFRESH DATA / ·ä†·ãµ·àµ</button>
        <div id="loading-ui">PROCESSING...</div>

        <h3 style="color:var(--green)">üì• DEPOSITS (·åà·äï·ãò·â• ·åà·â¢)</h3>
        <div id="dep-list">Fetching...</div>

        <h3 style="color:var(--red); margin-top:40px;">üì§ WITHDRAWALS (·åà·äï·ãò·â• ·ãà·å™)</h3>
        <div id="wit-list">Fetching...</div>
    </div>

    <script>
        // UPDATED ACTIVE URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw0kOovoQjv6IVSX2vbj7gba7-CtPXer7LFiC9738B8LYHmMc0O3Pzg5IL9U6MkvtKc/exec";

        function checkLock() {
            const pin = document.getElementById('adminPass').value;
            if(pin === '333') {
                document.getElementById('admin-lock').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                load();
            } else {
                alert("Wrong Pin!");
            }
        }

        async function load() {
            document.getElementById('loading-ui').style.display = 'block';
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getAdminData&t=${Date.now()}`);
                const data = await res.json();

                // 1. Render Deposits
                let dHtml = '';
                if(data.deposits && data.deposits.length > 0) {
                    data.deposits.forEach(d => {
                        dHtml += `<div class="card dep-card">
                            <span class="label">SENDER NAME (·ã®·àã·ä™ ·àµ·àù):</span> 
                            <span class="val">${d.senderName || 'Unknown'}</span>
                            
                            <span class="label">ACCOUNT PHONE (·ã®·ã∞·äï·â†·äõ·ãç ·àµ·àç·ä≠):</span> 
                            <span class="val">${d.phone}</span>
                            
                            <span class="label">RECEIPT PHONE (·ã®·àã·ä®·â†·âµ ·àµ·àç·ä≠):</span> 
                            <span class="val">${d.senderPhone || d.phone}</span>
                            
                            <div class="amt">
                                <span>${parseFloat(d.amount).toFixed(2)} ETB</span>
                                <span class="method-tag">${d.method}</span>
                            </div>
                            
                            <button class="btn btn-app" onclick="action('approveDeposit','${d.id}')">APPROVE DEPOSIT ‚úÖ</button>
                        </div>`;
                    });
                }
                document.getElementById('dep-list').innerHTML = dHtml || "<p style='color:#666; text-align:center;'>No pending deposits</p>";

                // 2. Render Withdrawals
                let wHtml = '';
                if(data.withdrawals && data.withdrawals.length > 0) {
                    data.withdrawals.forEach(w => {
                        wHtml += `<div class="card wit-card">
                            <span class="label">RECEIVER NAME (·ã®·â∞·âÄ·â£·ã≠ ·àµ·àù):</span> 
                            <span class="val">${w.senderName || 'Customer'}</span>
                            
                            <span class="label">SEND MONEY TO (·ã≠·àã·ä© ·ãà·ã∞):</span> 
                            <span class="val" style="font-size:1.2rem; color:white;">${w.senderPhone}</span>
                            
                            <div class="amt" style="color:var(--red)">
                                <span>${parseFloat(w.amount).toFixed(2)} ETB</span>
                                <span class="method-tag">${w.method}</span>
                            </div>
                            
                            <button class="btn btn-pay" onclick="if(confirm('Did you send ${w.amount} to ${w.senderPhone}?')) action('approveWithdrawal','${w.id}')">MARK AS PAID üí∏</button>
                        </div>`;
                    });
                }
                document.getElementById('wit-list').innerHTML = wHtml || "<p style='color:#666; text-align:center;'>No pending withdrawals</p>";
                
            } catch(e) {
                console.error(e);
                alert("Error loading data. Make sure the Web App is deployed as 'Anyone'.");
            }
            document.getElementById('loading-ui').style.display = 'none';
        }

        async function action(type, id) {
            document.getElementById('loading-ui').style.display = 'block';
            try {
                // Using a regular fetch for the admin actions to get the response message
                const res = await fetch(`${SCRIPT_URL}?action=${type}&id=${id}&t=${Date.now()}`);
                const result = await res.json();
                alert(result.message || "Success!");
                load();
            } catch(e) {
                // In case of CORS error, we still refresh because the action likely worked on the sheet
                alert("Request Sent! Refreshing list...");
                setTimeout(load, 2000);
            }
            document.getElementById('loading-ui').style.display = 'none';
        }
    </script>
</body>
</html>
