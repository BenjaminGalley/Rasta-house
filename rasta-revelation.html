<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RASTA REVELATION | 5x4 PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Goldman&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #FFD100; --green: #008542; --red: #E71D36; 
            --dark: #000000; 
        }
        
        body { 
            background: var(--dark);
            background-image: url('asset/background.fine.jpg');
            background-size: cover;
            background-position: center;
            color: white; 
            font-family: 'Goldman', cursive; 
            margin: 0; 
            text-align: center; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
        }

        /* --- HEADER --- */
        .header { 
            padding: 10px 15px; 
            background: rgba(0,0,0,0.7); 
            border-bottom: 2px solid var(--gold); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            z-index: 10;
        }
        .balance-box { 
            background: rgba(0, 133, 66, 0.8);
            padding: 5px 15px; 
            border-radius: 10px; 
            border: 1px solid var(--gold); 
            font-weight: 900;
            color: var(--gold);
        }

        /* --- 5x4 SLOT GRID --- */
        .slot-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            position: relative;
        }

        /* Moving Bet Selector Up */
        .top-bet-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 5px 15px;
            border: 2px solid var(--gold);
            border-radius: 5px;
            z-index: 5;
        }
        .top-bet-display span { font-size: 0.7rem; color: #aaa; display: block; }
        .top-bet-display b { font-size: 1.2rem; color: var(--gold); }

        .grid-container {
            display: flex;
            background: rgba(0, 0, 0, 0.2); /* Very light to show background */
            padding: 0;
            border-radius: 5px;
            border: 4px solid #000; /* Thick black outer border */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden;
            width: 95%;
            max-width: 500px;
            height: 400px; 
            position: relative;
        }

        .reel {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            transform: translateY(0);
            border-right: 1px solid rgba(0, 0, 0, 0.8); /* Vertical Grid Lines */
        }
        .reel:last-child { border-right: none; }

        .symbol {
            width: 100%;
            height: 100px; 
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.8); /* Horizontal Grid Lines */
            background: transparent; /* Remove any internal black boxes */
        }

        .symbol img {
            width: 85%;
            height: 85%;
            object-fit: contain;
            /* No background or borders here ensures they blend into the slide */
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
        }

        /* --- CONTROLS --- */
        .control-panel {
            background: rgba(0,0,0,0.9);
            padding: 15px 10px;
            border-top: 3px solid var(--green);
        }

        .status-msg { 
            color: var(--gold); 
            font-size: 1rem; 
            margin-bottom: 10px; 
            text-transform: uppercase; 
            height: 20px;
        }

        .ui-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .bet-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-circle {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            background: #222;
            color: var(--gold);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spin-btn {
            background: linear-gradient(#e71d36, #800);
            background: linear-gradient(var(--green), #004d26);
            color: white;
            padding: 12px 45px;
            border-radius: 30px;
            border: none;
            font-family: 'Goldman';
            font-size: 1.4rem;
            font-weight: bold;
            box-shadow: 0 4px 0 #002e17;
            cursor: pointer;
        }

        .spin-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #002e17; }
        .spin-btn:disabled { filter: grayscale(1); opacity: 0.5; }

        /* Animation */
        .spinning {
            transition: transform 2.5s cubic-bezier(0.45, 0.05, 0.55, 0.95);
        }
    </style>
</head>
<body>

<div class="header">
    <div onclick="location.href='index.html'" style="cursor:pointer; font-size: 1.5rem;">üè†</div>
    <div class="balance-box" id="userBalance">0.00 ETB</div>
    <div onclick="toggleMusic()" id="speaker" style="cursor:pointer; font-size: 1.5rem;">üîà</div>
</div>

<div class="slot-wrapper">
    <div class="top-bet-display">
        <span>TOTAL BET</span>
        <b id="betAmtTop">4.00</b>
    </div>

    <div class="grid-container" id="grid">
        <div class="reel" id="reel0"></div>
        <div class="reel" id="reel1"></div>
        <div class="reel" id="reel2"></div>
        <div class="reel" id="reel3"></div>
        <div class="reel" id="reel4"></div>
    </div>
</div>

<div class="control-panel">
    <div class="status-msg" id="msg">READY TO REVEAL</div>
    <div class="ui-row">
        <div class="bet-controls">
            <button class="btn-circle" onclick="changeBet(-4)">-</button>
            <button class="btn-circle" onclick="changeBet(4)">+</button>
        </div>

        <button class="spin-btn" id="spinBtn" onclick="spin()">SPIN</button>

        <div class="top-bet-display" style="position: static; border-color: var(--green);">
            <span>WINNINGS</span>
            <b id="lastWin">0.00</b>
        </div>
    </div>
</div>

<audio id="bgMusic" loop>
    <source src="https://www.free-stock-music.com/music/alexander-nakarada-be-jammin.mp3" type="audio/mpeg">
</audio>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzdPewsjld31mT1oBLhtCk_bkM5B_iVcaOeTMJUFMPxqgyH2bFJVYZIFTcZrPgxBrID/exec";
    let user = JSON.parse(localStorage.getItem('rasta_user')) || { balance: 1000, phone: "000" };
    let currentBet = 4;
    let isSpinning = false;

    const symbols = [
        { id: 'king', img: 'asset/king.jpg', weight: 5, mult: 50 },
        { id: 'bob', img: 'asset/bob.jpg', weight: 10, mult: 20 },
        { id: 'wild', img: 'asset/rasta-wild.jpg', weight: 12, mult: 15 },
        { id: 'lion', img: 'asset/lion.king.jpg', weight: 15, mult: 10 },
        { id: 'blunt', img: 'asset/blunt.jpg', weight: 20, mult: 5 },
        { id: 'tree', img: 'asset/tree.jpg', weight: 25, mult: 3 },
        { id: 'leaf', img: 'asset/mar.jpg', weight: 30, mult: 2 }
    ];

    let weightTable = [];
    symbols.forEach((s, index) => {
        for(let i=0; i<s.weight; i++) weightTable.push(index);
    });

    function init() {
        updateUI();
        syncBalance();
        for(let i=0; i<5; i++) {
            populateReel(i);
        }
    }

    function populateReel(reelIdx) {
        const reel = document.getElementById('reel' + reelIdx);
        reel.innerHTML = '';
        for(let i=0; i<20; i++) {
            const sym = document.createElement('div');
            sym.className = 'symbol';
            const randomIdx = weightTable[Math.floor(Math.random() * weightTable.length)];
            const data = symbols[randomIdx];
            sym.innerHTML = `<img src="${data.img}" alt="${data.id}">`;
            reel.appendChild(sym);
        }
    }

    function changeBet(val) {
        if(isSpinning) return;
        currentBet = Math.max(4, currentBet + val);
        document.getElementById('betAmtTop').innerText = currentBet.toFixed(2);
    }

    async function spin() {
        if(isSpinning || user.balance < currentBet) {
            if(user.balance < currentBet) alert("Insufficient Balance");
            return;
        }

        isSpinning = true;
        user.balance -= currentBet;
        updateUI();
        
        document.getElementById('spinBtn').disabled = true;
        document.getElementById('msg').innerText = "REVEALING...";
        document.getElementById('lastWin').innerText = "0.00";

        const reelResults = [];

        for(let i=0; i<5; i++) {
            const reel = document.getElementById('reel' + i);
            const resultIndices = [];
            for(let r=0; r<4; r++) {
                resultIndices.push(weightTable[Math.floor(Math.random() * weightTable.length)]);
            }
            reelResults.push(resultIndices);

            const strip = reel.children;
            for(let r=0; r<4; r++) {
                strip[r].querySelector('img').src = symbols[resultIndices[r]].img;
            }

            reel.style.transition = 'none';
            reel.style.transform = `translateY(-1600px)`; 
            void reel.offsetWidth; 
            reel.style.transition = `transform ${2 + (i * 0.2)}s cubic-bezier(0.1, 0, 0.1, 1)`;
            reel.style.transform = `translateY(0px)`; 
        }

        setTimeout(() => {
            calculateWin(reelResults);
            isSpinning = false;
            document.getElementById('spinBtn').disabled = false;
        }, 3000);
    }

    function calculateWin(results) {
        let totalWin = 0;
        // Check Middle Row (Index 1)
        const midRow = [results[0][1], results[1][1], results[2][1], results[3][1], results[4][1]];
        let matchCount = 1;
        let matchIconIdx = midRow[0];

        for(let i=1; i<5; i++) {
            if(midRow[i] === matchIconIdx) matchCount++;
            else break;
        }

        if(matchCount >= 3) {
            const multiplier = symbols[matchIconIdx].mult * (matchCount - 2);
            totalWin = currentBet * multiplier;
            document.getElementById('msg').innerText = `BIG WIN! +${totalWin} ETB`;
            document.getElementById('lastWin').innerText = totalWin.toFixed(2);
            user.balance += totalWin;
            updateUI();
            saveAndSync();
        } else {
            document.getElementById('msg').innerText = "TRY AGAIN";
            saveAndSync();
        }
    }

    function updateUI() {
        document.getElementById('userBalance').innerText = parseFloat(user.balance).toFixed(2) + " ETB";
        document.getElementById('betAmtTop').innerText = currentBet.toFixed(2);
        localStorage.setItem('rasta_user', JSON.stringify(user));
    }

    async function syncBalance() {
        try {
            const res = await fetch(`${SCRIPT_URL}?action=login&phone=${user.phone}`);
            const data = await res.json();
            if(data.balance) { user.balance = data.balance; updateUI(); }
        } catch(e) { console.log("Offline mode"); }
    }

    function saveAndSync() {
        fetch(`${SCRIPT_URL}?action=login&phone=${user.phone}&updateBal=${user.balance}`);
    }

    function toggleMusic() {
        const music = document.getElementById('bgMusic');
        const speaker = document.getElementById('speaker');
        if(music.paused) { music.play(); speaker.innerText = "üîä"; } 
        else { music.pause(); speaker.innerText = "üîà"; }
    }

    window.onload = init;
</script>
</body>
</html>
