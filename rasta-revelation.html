<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RASTA REVELATION | 5x4 PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Goldman&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #FFD100; --green: #008542; --red: #E71D36; 
            --dark: #000000; 
        }
        
        body { 
            background: var(--dark);
            background-image: url('asset/background.fine.jpg');
            background-size: cover;
            background-position: center;
            color: white; 
            font-family: 'Goldman', cursive; 
            margin: 0; 
            text-align: center; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
        }

        /* --- HEADER --- */
        .header { 
            padding: 10px 15px; 
            background: rgba(0,0,0,0.7); 
            border-bottom: 2px solid var(--gold); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            z-index: 10;
        }
        .balance-box { 
            background: rgba(0, 133, 66, 0.8);
            padding: 5px 15px; 
            border-radius: 10px; 
            border: 1px solid var(--gold); 
            font-weight: 900;
            color: var(--gold);
        }

        /* --- 5x4 SLOT GRID --- */
        .slot-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .grid-container {
            display: flex;
            gap: 5px;
            background: rgba(0, 0, 0, 0.5); /* Transparent to let background show */
            padding: 10px;
            border-radius: 10px;
            border: 3px solid rgba(255, 209, 0, 0.3);
            overflow: hidden;
            width: 95%;
            max-width: 500px;
            height: 400px; /* Fixed height for 4 rows */
            position: relative;
        }

        .reel {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            transform: translateY(0);
        }

        .symbol {
            width: 100%;
            height: 100px; /* 400px container / 4 rows = 100px */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .symbol img {
            width: 90%;
            height: 90%;
            object-fit: contain;
            /* No background on images allows the "floating" effect */
        }

        /* --- CONTROLS --- */
        .control-panel {
            background: rgba(0,0,0,0.85);
            padding: 15px 10px;
            border-top: 3px solid var(--green);
        }

        .status-msg { 
            color: var(--gold); 
            font-size: 1rem; 
            margin-bottom: 10px; 
            text-transform: uppercase; 
            height: 20px;
        }

        .ui-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .bet-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-circle {
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            background: #111;
            color: var(--gold);
            font-weight: bold;
            cursor: pointer;
        }

        .bet-display {
            text-align: center;
            min-width: 60px;
        }

        .bet-display span { font-size: 0.6rem; color: #ccc; display: block; }
        .bet-display b { font-size: 1.2rem; color: var(--gold); }

        .spin-btn {
            background: linear-gradient(var(--green), #004d26);
            color: white;
            padding: 15px 40px;
            border-radius: 30px;
            border: none;
            font-family: 'Goldman';
            font-size: 1.4rem;
            font-weight: bold;
            box-shadow: 0 4px 0 #002e17;
            cursor: pointer;
        }

        .spin-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #002e17; }
        .spin-btn:disabled { filter: grayscale(1); opacity: 0.5; }

        /* Animation Classes */
        .spinning {
            transition: transform 2.5s cubic-bezier(0.45, 0.05, 0.55, 0.95);
        }

        .win-flash {
            animation: flash 0.5s infinite;
        }
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

<div class="header">
    <div onclick="location.href='index.html'" style="cursor:pointer;">üè†</div>
    <div class="balance-box" id="userBalance">0.00 ETB</div>
    <div onclick="toggleMusic()" id="speaker" style="cursor:pointer;">üîà</div>
</div>

<div class="slot-wrapper">
    <div class="grid-container" id="grid">
        <div class="reel" id="reel0"></div>
        <div class="reel" id="reel1"></div>
        <div class="reel" id="reel2"></div>
        <div class="reel" id="reel3"></div>
        <div class="reel" id="reel4"></div>
    </div>
</div>

<div class="control-panel">
    <div class="status-msg" id="msg">READY TO ROLL</div>
    <div class="ui-row">
        <div class="bet-controls">
            <button class="btn-circle" onclick="changeBet(-4)">-</button>
            <div class="bet-display">
                <span>BET</span>
                <b id="betAmt">4</b>
            </div>
            <button class="btn-circle" onclick="changeBet(4)">+</button>
        </div>

        <button class="spin-btn" id="spinBtn" onclick="spin()">SPIN</button>

        <div class="bet-display">
            <span>WIN</span>
            <b id="lastWin">0</b>
        </div>
    </div>
</div>

<audio id="bgMusic" loop>
    <source src="https://www.free-stock-music.com/music/alexander-nakarada-be-jammin.mp3" type="audio/mpeg">
</audio>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzdPewsjld31mT1oBLhtCk_bkM5B_iVcaOeTMJUFMPxqgyH2bFJVYZIFTcZrPgxBrID/exec";
    let user = JSON.parse(localStorage.getItem('rasta_user')) || { balance: 1000, phone: "000" };
    let currentBet = 4;
    let isSpinning = false;

    // ASSET DEFINITIONS
    const symbols = [
        { id: 'king', img: 'asset/king.jpg', weight: 5, mult: 50 },      // Rare
        { id: 'bob', img: 'asset/bob.jpg', weight: 10, mult: 20 },
        { id: 'wild', img: 'asset/rasta-wild.jpg', weight: 12, mult: 15 },
        { id: 'lion', img: 'asset/lion.king.jpg', weight: 15, mult: 10 },
        { id: 'blunt', img: 'asset/blunt.jpg', weight: 20, mult: 5 },
        { id: 'tree', img: 'asset/tree.jpg', weight: 25, mult: 3 },
        { id: 'leaf', img: 'asset/mar.jpg', weight: 30, mult: 2 }        // Common
    ];

    // Build Weight Table for RTP control
    let weightTable = [];
    symbols.forEach((s, index) => {
        for(let i=0; i<s.weight; i++) weightTable.push(index);
    });

    function init() {
        updateUI();
        syncBalance();
        for(let i=0; i<5; i++) {
            populateReel(i, true);
        }
    }

    function populateReel(reelIdx, initial = false) {
        const reel = document.getElementById('reel' + reelIdx);
        reel.innerHTML = '';
        // Create 20 symbols for the slide effect
        for(let i=0; i<20; i++) {
            const sym = document.createElement('div');
            sym.className = 'symbol';
            const randomIdx = weightTable[Math.floor(Math.random() * weightTable.length)];
            const data = symbols[randomIdx];
            sym.innerHTML = `<img src="${data.img}" alt="${data.id}">`;
            reel.appendChild(sym);
        }
    }

    function changeBet(val) {
        if(isSpinning) return;
        currentBet = Math.max(4, currentBet + val);
        document.getElementById('betAmt').innerText = currentBet;
    }

    async function spin() {
        if(isSpinning || user.balance < currentBet) return;

        isSpinning = true;
        user.balance -= currentBet;
        updateUI();
        
        document.getElementById('spinBtn').disabled = true;
        document.getElementById('msg').innerText = "SHUFFLING...";
        document.getElementById('lastWin').innerText = "0";

        const reelResults = [];

        for(let i=0; i<5; i++) {
            const reel = document.getElementById('reel' + i);
            
            // Determine result for this reel (4 symbols visible)
            const resultIndices = [];
            for(let r=0; r<4; r++) {
                resultIndices.push(weightTable[Math.floor(Math.random() * weightTable.length)]);
            }
            reelResults.push(resultIndices);

            // Inject results into the top 4 positions of the reel strip
            const strip = reel.children;
            for(let r=0; r<4; r++) {
                strip[r].querySelector('img').src = symbols[resultIndices[r]].img;
            }

            // Standard Slide Downwards Animation
            reel.style.transition = 'none';
            reel.style.transform = `translateY(-1600px)`; // Start from top
            void reel.offsetWidth; 
            reel.style.transition = `transform ${2 + (i * 0.2)}s cubic-bezier(0.1, 0, 0.1, 1)`;
            reel.style.transform = `translateY(0px)`; // Slide down to show index 0-3
        }

        setTimeout(() => {
            calculateWin(reelResults);
            isSpinning = false;
            document.getElementById('spinBtn').disabled = false;
        }, 3000);
    }

    function calculateWin(results) {
        // Simple Payline Logic (Middle Row - Index 1)
        let win = 0;
        const midRow = [results[0][1], results[1][1], results[2][1], results[3][1], results[4][1]];
        
        // Check for 3, 4, or 5 matches starting from left
        let matchCount = 1;
        let matchIconIdx = midRow[0];

        for(let i=1; i<5; i++) {
            if(midRow[i] === matchIconIdx) matchCount++;
            else break;
        }

        if(matchCount >= 3) {
            const multiplier = symbols[matchIconIdx].mult * (matchCount - 2);
            win = currentBet * multiplier;
            document.getElementById('msg').innerText = `REVELATION! +${win} ETB`;
            document.getElementById('lastWin').innerText = win;
            user.balance += win;
            updateUI();
            saveAndSync();
        } else {
            document.getElementById('msg').innerText = "TRY AGAIN";
            saveAndSync();
        }
    }

    function updateUI() {
        document.getElementById('userBalance').innerText = parseFloat(user.balance).toFixed(2) + " ETB";
        localStorage.setItem('rasta_user', JSON.stringify(user));
    }

    async function syncBalance() {
        try {
            const res = await fetch(`${SCRIPT_URL}?action=login&phone=${user.phone}`);
            const data = await res.json();
            if(data.balance) { user.balance = data.balance; updateUI(); }
        } catch(e) { console.log("Offline mode"); }
    }

    function saveAndSync() {
        fetch(`${SCRIPT_URL}?action=login&phone=${user.phone}&updateBal=${user.balance}`);
    }

    function toggleMusic() {
        const music = document.getElementById('bgMusic');
        const speaker = document.getElementById('speaker');
        if(music.paused) { music.play(); speaker.innerText = "üîä"; } 
        else { music.pause(); speaker.innerText = "üîà"; }
    }

    window.onload = init;
</script>
</body>
</html>
