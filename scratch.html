<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RASTA GOLD SCRATCH</title>
    <link href="https://fonts.googleapis.com/css2?family=Goldman&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #FFD100; --green: #008542; --dark: #051a0c; --neon: #00ff66; }
        body { background: var(--dark); color: white; font-family: 'Goldman', sans-serif; text-align: center; margin: 0; overflow: hidden; touch-action: none; }
        .header { padding: 15px; background: rgba(0,0,0,0.9); border-bottom: 3px solid var(--gold); display: flex; justify-content: space-between; align-items: center; }
        .bal-display { background: linear-gradient(to right, var(--green), #004d26); padding: 8px 18px; border-radius: 20px; border: 1px solid var(--gold); font-weight: bold; min-width: 100px; }
        
        /* NO ASSET NEEDED - CSS GENESIS SYMBOLS */
        .card-container { margin: 20px auto; width: 320px; height: 320px; position: relative; background: radial-gradient(circle, #1a3c1a, #051a0c); border-radius: 15px; border: 5px solid #333; box-shadow: 0 0 40px rgba(0,0,0,0.8); overflow: hidden; }
        .prize-grid { display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); width: 100%; height: 100%; }
        .prize-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.05); }
        .sym-icon { font-size: 3rem; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
        .sym-mult { font-size: 0.7rem; color: var(--gold); margin-top: 5px; opacity: 0.8; }

        canvas { position: absolute; top: 0; left: 0; cursor: pointer; z-index: 5; }
        #msg { height: 35px; color: var(--gold); font-weight: bold; margin: 15px 0; text-transform: uppercase; font-size: 1.1rem; text-shadow: 0 0 10px rgba(255,209,0,0.4); }

        .controls { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.9); padding: 20px 0; border-top: 3px solid var(--gold); }
        .bet-bar { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 15px; }
        .step-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--gold); background: #222; color: var(--gold); font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .bet-info { background: #000; padding: 5px 25px; border-radius: 10px; border: 1px solid #444; }
        .bet-info small { display: block; font-size: 0.6rem; color: #888; }
        .bet-info b { font-size: 1.4rem; color: var(--gold); }
        .btn-buy { width: 80%; padding: 15px; background: linear-gradient(var(--green), #004d26); color: white; border: none; border-radius: 50px; font-weight: 900; font-size: 1.4rem; cursor: pointer; box-shadow: 0 5px 0 #002e17; }
        .btn-buy:disabled { filter: grayscale(1); opacity: 0.5; transform: none; box-shadow: none; }
    </style>
</head>
<body>

<div class="header">
    <div onclick="location.href='index.html'" style="cursor:pointer; font-size: 1.5rem;">‚úï</div>
    <div class="bal-display" id="balDisplay">0.00</div>
    <div id="status" style="font-size: 0.7rem; color: var(--neon);">CONNECTED</div>
</div>

<div class="card-container">
    <div class="prize-grid" id="grid">
        <div class="prize-cell"><div class="sym-icon">ü¶Å</div><div class="sym-mult">x50</div></div>
        <div class="prize-cell"><div class="sym-icon">üíé</div><div class="sym-mult">x20</div></div>
        <div class="prize-cell"><div class="sym-icon">üí∞</div><div class="sym-mult">x10</div></div>
        <div class="prize-cell"><div class="sym-icon">üçÄ</div><div class="sym-mult">x5</div></div>
    </div>
    <canvas id="cvs" width="320" height="320"></canvas>
</div>

<div id="msg">BUY TICKET TO START</div>

<div class="controls">
    <div class="bet-bar">
        <button class="step-btn" onclick="adj(-5)">-</button>
        <div class="bet-info"><small>COST</small><b id="bet">5</b></div>
        <button class="step-btn" onclick="adj(5)">+</button>
    </div>
    <button class="btn-buy" onclick="buy()" id="buyBtn">BUY TICKET</button>
</div>

<script>
    const SCRIPT = "https://script.google.com/macros/s/AKfycbzdPewsjld31mT1oBLhtCk_bkM5B_iVcaOeTMJUFMPxqgyH2bFJVYZIFTcZrPgxBrID/exec";
    let user = JSON.parse(localStorage.getItem('rasta_user'));
    let bet = 5;
    let active = false;
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    const icons = [{i:'ü¶Å', m:50}, {i:'üíé', m:20}, {i:'üí∞', m:10}, {i:'üçÄ', m:5}];

    function init() {
        if(!user) return window.location.href='index.html';
        document.getElementById('balDisplay').innerText = parseFloat(user.balance).toFixed(2);
        cover();
    }

    function cover() {
        ctx.globalCompositeOperation = 'source-over';
        let g = ctx.createLinearGradient(0,0,320,320);
        g.addColorStop(0, '#8A6E00'); g.addColorStop(0.5, '#FFD100'); g.addColorStop(1, '#C5A000');
        ctx.fillStyle = g; ctx.fillRect(0,0,320,320);
        ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.font = "20px Goldman"; ctx.textAlign="center";
        ctx.fillText("RASTA GOLD", 160, 160);
    }

    function adj(v) { if(!active) { bet = Math.max(5, bet + v); document.getElementById('bet').innerText = bet; } }

    function buy() {
        if(user.balance < bet) return alert("Low Balance");
        user.balance -= bet;
        sync();
        active = true;
        document.getElementById('buyBtn').disabled = true;
        document.getElementById('msg').innerText = "SCRATCH NOW!";
        
        const results = Array.from({length:4}, () => icons[Math.floor(Math.random()*icons.length)]);
        const grid = document.getElementById('grid');
        grid.innerHTML = results.map(r => `<div class="prize-cell"><div class="sym-icon">${r.i}</div><div class="sym-mult">x${r.m}</div></div>`).join('');
        
        // Win Logic
        let win = 0;
        const counts = {};
        results.forEach(r => { counts[r.i] = (counts[r.i] || 0) + 1; if(counts[r.i] >= 3) win = bet * r.m; });
        cvs.win = win;
    }

    function scratch(e) {
        if(!active) return;
        const r = cvs.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - r.left;
        const y = (e.clientY || e.touches[0].clientY) - r.top;
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath(); ctx.arc(x, y, 30, 0, Math.PI*2); ctx.fill();
        
        // Percent Check
        const d = ctx.getImageData(0,0,320,320).data;
        let c = 0; for(let i=3; i<d.length; i+=4) if(d[i]===0) c++;
        if((c/(320*320)) > 0.45) finish();
    }

    function finish() {
        active = false;
        cvs.style.opacity = "0";
        setTimeout(() => {
            if(cvs.win > 0) { user.balance += cvs.win; document.getElementById('msg').innerText = "WIN: "+cvs.win+" ETB"; }
            else { document.getElementById('msg').innerText = "TRY AGAIN"; }
            sync();
            document.getElementById('buyBtn').disabled = false;
            cover(); cvs.style.opacity = "1";
        }, 500);
    }

    function sync() {
        document.getElementById('balDisplay').innerText = parseFloat(user.balance).toFixed(2);
        localStorage.setItem('rasta_user', JSON.stringify(user));
        fetch(`${SCRIPT}?action=login&phone=${user.phone}&updateBal=${user.balance}`);
    }

    cvs.addEventListener('mousemove', (e) => { if(e.buttons===1) scratch(e); });
    cvs.addEventListener('touchmove', (e) => { e.preventDefault(); scratch(e); });
    window.onload = init;
</script>
</body>
</html>
